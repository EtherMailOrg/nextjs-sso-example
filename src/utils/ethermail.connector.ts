import { createConnector } from '@wagmi/core'
import { EtherMailSignInOnSuccessEvent, EtherMailTokenErrorEvent } from "@/intefaces/web3.interfaces";
import { JwtUtils } from "@/utils/jwt.utils";
import { EthermailLoginData } from "@/intefaces/ethermail.interfaces";
import { EtherMailProvider } from "@ethermail/ethermail-wallet-provider";
import { BrowserProvider } from "ethers";
import Web3 from "web3";
import { toast } from "react-hot-toast";
import { Chain } from "viem";

export type EthermailConnectorParameters = {
  widget_id: string;
  afid: string;
  community_name: string;
  permissions: string;
  loginType: string;
  connectButtonLabel?: string
}

export function ethermailConnector(parameters: EthermailConnectorParameters) {
  let ethermailProvider: EtherMailProvider | null;
  let provider: BrowserProvider | null;

  return createConnector((config: any) => {
    let isConnected: boolean = false;

    return {
      id: 'ethermail',
      name: 'Ethermail',
      type: 'ethermail',
      icon: 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'588\' height=\'512\'%3E%3Cpath d=\'M0 0 C2.20099153 -0.02530552 4.40251133 -0.01697918 6.60338974 0.01675987 C7.81553894 0.01163332 9.02768814 0.00650677 10.27656913 0.00122488 C13.64317685 -0.00695982 17.00769869 0.01182313 20.37405443 0.04189324 C24.00319302 0.0677769 27.63226588 0.05903774 31.26147079 0.0544796 C37.54979635 0.05133172 43.8377487 0.07017448 50.12598038 0.10390663 C59.21766838 0.15264574 68.30917572 0.16829288 77.4009802 0.17583458 C92.15131199 0.18897005 106.90144481 0.22890963 121.65166855 0.28565025 C135.9810855 0.34071486 150.31044843 0.38319005 164.6399498 0.40869713 C165.96459949 0.41106164 165.96459949 0.41106164 167.31600979 0.41347392 C171.746212 0.42130408 176.1764146 0.42888634 180.60661745 0.43634534 C217.36624112 0.49855719 254.12563857 0.60424612 290.88506699 0.73828697 C291.28331177 1.45142555 291.68155655 2.16456413 292.09186935 2.89931297 C293.59233188 5.58523875 295.09356228 8.27073353 296.59528732 10.9559536 C297.55561895 12.67364238 298.51509132 14.39181147 299.47454453 16.10999107 C302.86357348 22.16855936 306.28090058 28.20504497 309.82256699 34.17578697 C310.23473465 34.8707679 310.64690231 35.56574883 311.07155991 36.28178978 C311.44700943 36.91454323 311.82245895 37.54729668 312.20928574 38.19922447 C315.56652163 43.8715731 318.84667324 49.5883558 322.13506699 55.30078697 C327.02652022 63.79484997 331.93894 72.27594267 336.88506699 80.73828697 C344.90795957 94.46871035 352.84365063 108.24906847 360.7805748 122.0293026 C367.4546301 133.61510463 374.13970783 145.1938205 380.88506699 156.73828697 C388.9077421 170.46883885 396.84364957 184.24906663 404.7805748 198.0293026 C411.64546043 209.94637584 418.5216476 221.85655332 425.44756699 233.73828697 C426.00710068 234.69879967 426.56663437 235.65931236 427.14312363 236.6489315 C427.94544418 238.02347496 427.94544418 238.02347496 428.76397324 239.42578697 C429.27460312 240.31008385 429.785233 241.19438072 430.31133652 242.10547447 C431.39026013 243.91048723 432.5195071 245.68608385 433.6892662 247.43359947 C434.2579039 248.29727135 434.8265416 249.16094322 435.41241074 250.05078697 C435.93440048 250.81004478 436.45639023 251.5693026 436.99419785 252.35156822 C438.27096437 255.77214086 437.33145941 257.45199054 435.88506699 260.73828697 C434.95228101 262.55150954 433.96612737 264.33800558 432.93584824 266.09766197 C432.34287949 267.11731041 431.74991074 268.13695885 431.13897324 269.18750572 C430.49830917 270.27676353 429.85764511 271.36602135 429.19756699 272.48828697 C428.52250059 273.64549669 427.84803237 274.80305554 427.17412949 275.96094322 C425.77490894 278.3639928 424.37313763 280.76552617 422.96953964 283.16602135 C419.75057334 288.67615509 416.56986854 294.20836314 413.38506699 299.73828697 C412.13524574 301.90505676 410.88524518 304.07172312 409.63506699 306.23828697 C409.01631699 307.31078697 408.39756699 308.38328697 407.76006699 309.48828697 C385.88506699 347.40495364 364.01006699 385.32162031 342.13506699 423.23828697 C341.51623642 424.3109481 340.89740585 425.38360924 340.25982285 426.48877525 C339.01071181 428.65385768 337.76152569 430.81889679 336.51226425 432.98389244 C333.37304389 438.42444403 330.23516136 443.86575913 327.09991074 449.30859947 C319.27048648 462.8971821 311.40652383 476.46490695 303.48662949 490.00098228 C302.43132247 491.80465641 301.37662011 493.60868448 300.32256699 495.41309166 C298.90757526 497.83497528 297.49049629 500.25562234 296.07256699 502.67578697 C295.65773056 503.38614098 295.24289413 504.09649498 294.81548691 504.82837486 C292.00032998 509.62302398 292.00032998 509.62302398 290.88506699 510.73828697 C289.3186554 510.84692035 287.74737144 510.88590439 286.17724133 510.89764786 C284.6402526 510.91266006 284.6402526 510.91266006 283.07221359 510.92797554 C281.36302367 510.93690761 281.36302367 510.93690761 279.61930466 510.94602013 C278.41944681 510.95604691 277.21958897 510.96607369 275.98337179 510.97640431 C272.63761656 511.00305967 269.29189048 511.02506773 265.94609177 511.04492021 C263.07996224 511.0626894 260.21386437 511.08411464 257.3477596 511.10545991 C230.17488286 511.30676519 203.001224 511.41031489 175.82776165 511.49397659 C172.28900144 511.50506515 168.75024196 511.51635738 165.211483 511.52783775 C163.89213194 511.53210455 163.89213194 511.53210455 162.54612733 511.53645755 C148.3022221 511.58392269 134.05905939 511.68021756 119.81555849 511.79540883 C105.1976719 511.91264804 90.58017125 511.98064527 75.96182638 512.00210774 C67.75164627 512.01551325 59.54284808 512.05128956 51.33313942 512.14334297 C44.33954842 512.22174717 37.34750053 512.25626101 30.3534764 512.23331808 C26.78468206 512.22300606 23.2192385 512.23371708 19.65099907 512.3014164 C-1.18528955 512.67675328 -1.18528955 512.67675328 -6.00405383 509.48830652 C-9.30131624 506.07466824 -10.64172556 502.21881611 -12.11493301 497.73828697 C-13.25028759 495.69940027 -14.42337781 493.68058093 -15.65008926 491.69531822 C-16.82778651 489.64824223 -18.00350839 487.60002876 -19.17743301 485.55078697 C-20.15644415 483.84785916 -21.13545849 482.14493317 -22.11465836 480.44211388 C-23.119406 478.69433237 -24.12333216 476.94608101 -25.12714005 475.19775963 C-28.28215931 469.7068946 -31.44891265 464.22281352 -34.61493301 458.73828697 C-35.86499413 456.57165557 -37.11499401 454.40498883 -38.36493301 452.23828697 C-38.98368301 451.16578697 -39.60243301 450.09328697 -40.23993301 448.98828697 C-45.86493301 439.23828698 -45.86493301 439.23828698 -47.74017715 435.98779869 C-48.98928819 433.82271627 -50.23847431 431.65767715 -51.48773575 429.4926815 C-54.62695611 424.05212991 -57.76483864 418.61081481 -60.90008926 413.16797447 C-66.9454846 402.67596604 -73.0060352 392.19347021 -79.11493301 381.73828697 C-85.86194495 370.19099181 -92.54832619 358.6092667 -99.22381973 347.02051353 C-102.3517345 341.59168755 -105.48351749 336.16509416 -108.61493301 330.73828697 C-109.8649518 328.57163115 -111.1149518 326.40496448 -112.36493301 324.23828697 C-112.98368301 323.16578697 -113.60243301 322.09328697 -114.23993301 320.98828697 C-119.86493301 311.23828697 -119.86493301 311.23828697 -121.7428627 307.98316002 C-122.98304063 305.83355063 -124.22327428 303.68397339 -125.46356583 301.53442955 C-128.38843531 296.46519485 -131.31274134 291.39563761 -134.2350502 286.32492638 C-135.61300239 283.934021 -136.99127474 281.54330026 -138.36957169 279.15259361 C-139.34034284 277.46844734 -140.31065176 275.78403466 -141.28094864 274.0996151 C-141.87069473 273.076744 -142.46044083 272.05387291 -143.06805801 271.00000572 C-143.84391251 269.65362022 -143.84391251 269.65362022 -144.63544083 268.28003502 C-145.6410634 266.55238872 -146.68782722 264.84817943 -147.76971817 263.16724205 C-149.92847356 259.26933691 -149.94731395 256.07409677 -149.11493301 251.73828697 C-147.44547853 247.83250546 -145.25301226 244.32545776 -142.98993301 240.73828697 C-141.69337496 238.60425826 -140.39917397 236.46879601 -139.10712051 234.33203697 C-138.10890274 232.69621666 -138.10890274 232.69621666 -137.09051895 231.02734947 C-133.97150526 225.8346465 -131.04568615 220.53878 -128.11493301 215.23828697 C-122.98142771 206.00744937 -117.71276819 196.86585 -112.36493301 187.75781822 C-108.19249342 180.63300507 -104.12998058 173.45282556 -100.11493301 166.23828697 C-94.97861912 157.00897295 -89.71280767 147.86591724 -84.36493301 138.75781822 C-80.19249342 131.63300507 -76.12998058 124.45282556 -72.11493301 117.23828697 C-66.97861912 108.00897295 -61.71280767 98.86591724 -56.36493301 89.75781822 C-52.19249342 82.63300507 -48.12998058 75.45282556 -44.11493301 68.23828697 C-38.98596802 59.02217799 -33.73001962 49.89077825 -28.38690567 40.797369 C-23.37616789 32.24565338 -18.527422 23.60776705 -13.73212051 14.93359947 C-13.18555801 13.94875572 -12.63899551 12.96391197 -12.07587051 11.94922447 C-11.59940079 11.086036 -11.12293106 10.22284752 -10.63202286 9.33350182 C-10.13138321 8.47708092 -9.63074356 7.62066002 -9.11493301 6.73828697 C-8.66533344 5.70964216 -8.21573387 4.68099735 -7.75251007 3.62118149 C-4.75248596 0.34212921 -4.22270668 0.28285811 0 0 Z M29.23589706 88.41748619 C27.90021065 91.55616836 26.7770426 94.65520167 25.7885046 97.91897678 C24.5620577 101.74628505 22.75363522 104.8305633 20.65850449 108.25000572 C19.52333884 110.30730282 18.39045874 112.36586297 17.26006699 114.42578697 C11.43588011 124.96906633 5.51714238 135.45184775 -0.4826088 145.89600182 C-3.65714124 151.42365763 -6.82479957 156.95524553 -9.98993301 162.48828697 C-10.32882553 163.08061119 -10.66771805 163.67293541 -11.01688004 164.28320885 C-16.43416731 173.75561032 -21.7850792 183.26370355 -27.10443497 192.79150963 C-31.23717535 200.18830642 -35.42184485 207.55370943 -39.63397598 214.9055233 C-43.43824975 221.54743195 -47.22081518 228.20136445 -50.98993301 234.86328697 C-51.51337296 235.78706139 -52.0368129 236.7108358 -52.57611465 237.66260338 C-53.58806021 239.45283205 -54.58712299 241.25041091 -55.57245255 243.05542564 C-57.11493301 245.73828697 -57.11493301 245.73828697 -59.02850723 248.47778893 C-60.85633531 251.24501966 -62.20701327 253.5455022 -63.11493301 256.73828697 C-62.18279123 260.99415775 -59.95313117 264.13083807 -57.48993301 267.67578697 C-56.13953817 269.78992562 -54.79199347 271.90588687 -53.44696426 274.02344322 C-52.73105118 275.12059654 -52.01513809 276.21774986 -51.27753067 277.34815025 C-48.0237606 282.38729716 -45.10816161 287.62378414 -42.17013931 292.85068321 C-40.50045572 295.8152968 -38.81077311 298.76846779 -37.12274551 301.72266197 C-36.78882294 302.30787117 -36.45490036 302.89308037 -36.11085892 303.49602318 C-30.76746932 312.85799035 -25.36696216 322.18715629 -19.97381973 331.52051353 C-16.85168696 336.92499343 -13.73352097 342.33176109 -10.61493301 347.73828697 C-9.3649518 349.90496448 -8.1149518 352.07163115 -6.86493301 354.23828697 C-4.36493301 358.57162031 -1.86493301 362.90495364 0.63506699 367.23828697 C1.25397812 368.31102867 1.87288925 369.38377037 2.51055527 370.48901939 C3.75905921 372.65316877 5.00743185 374.8173939 6.25567245 376.98169518 C9.40248356 382.4375087 12.55164869 387.89193881 15.70537949 393.34375572 C16.34282089 394.44654869 16.9802623 395.54934166 17.63702011 396.6855526 C18.81451204 398.72252768 19.99278271 400.75905301 21.17217636 402.7949276 C27.49140207 413.73120609 33.66898302 424.74059996 39.88506699 435.73828697 C108.19506699 435.73828697 176.50506699 435.73828697 246.88506699 435.73828697 C252.16506699 426.49828697 257.44506699 417.25828697 262.88506699 407.73828697 C270.75692125 394.05932711 278.65645747 380.39860612 286.61822128 366.77197838 C292.78451829 356.21181613 298.89011738 345.61686152 304.9939537 335.02051353 C308.74453098 328.51099109 312.50008688 322.00433917 316.25542831 315.49756432 C319.4089186 310.03294035 322.55973739 304.56680795 325.70537949 299.09766197 C326.33581161 298.00292564 326.96624374 296.90818932 327.61577988 295.78027916 C328.86735761 293.60522126 330.11658886 291.42881127 331.36333847 289.25098228 C334.42405738 283.92226619 337.5402764 278.64332113 340.78741074 273.42578697 C341.40342148 272.42450768 342.01943222 271.42322838 342.65410995 270.39160728 C343.81942076 268.50515533 345.001223 266.62875643 346.20196152 264.76465416 C346.71742538 263.92579674 347.23288925 263.08693932 347.76397324 262.22266197 C348.22360458 261.49788658 348.68323593 260.77311119 349.1567955 260.02637291 C350.46445867 255.91795211 348.40099133 252.7411812 346.51910019 249.08301353 C345.99662704 248.19066002 345.4741539 247.2983065 344.93584824 246.37891197 C344.34279892 245.3591024 343.7497496 244.33929283 343.1387291 243.28857994 C342.4981456 242.19948326 341.8575621 241.11038658 341.19756699 239.98828697 C340.52323984 238.83253818 339.8495038 237.67644431 339.17632675 236.52002525 C337.77776902 234.11848149 336.37668405 231.71843894 334.97393417 229.31934166 C331.73030787 223.76596828 328.52990021 218.18766667 325.32256699 212.61328697 C319.96354328 203.31660941 314.56872077 194.04139324 309.1543541 184.77686119 C304.23455417 176.35259358 299.35984561 167.90274801 294.49053574 159.44922447 C289.7415148 151.20972231 284.95616575 142.99199598 280.1567955 134.781744 C275.85021363 127.40854647 271.58167325 120.01398958 267.32256699 112.61328697 C262.42547124 104.11012477 257.4953374 95.62759009 252.51006699 87.17578697 C251.95633408 86.23525475 251.40260117 85.29472252 250.83208847 84.32568932 C250.32621201 83.47055748 249.82033554 82.61542564 249.29912949 81.73438072 C248.85520859 80.98342125 248.41128769 80.23246178 247.95391464 79.45874596 C246.99938494 77.7767764 246.99938494 77.7767764 245.88506699 76.73828697 C243.24966943 76.58724828 240.63851668 76.50130536 238.00049973 76.45653343 C237.16422788 76.43874543 236.32795604 76.42095742 235.46634263 76.40263039 C232.64155903 76.34441905 229.8166959 76.29394238 226.99175644 76.24390221 C224.97493914 76.20492336 222.958124 76.16583283 220.94131088 76.12663841 C202.4823106 75.78002634 184.02139533 75.57621828 165.55996037 75.41266346 C153.14664781 75.30005026 140.73721191 75.14241621 128.3262291 74.87280846 C117.50122956 74.63770323 106.67896263 74.4877356 95.8514573 74.43949276 C90.12112544 74.41113577 84.39826819 74.34150057 78.67027855 74.17020035 C49.68636064 71.69961033 49.68636064 71.69961033 29.23589706 88.41748619 Z \' fill=\'%239D8BF5\' transform=\'translate(149.11493301391602,0.26171302795410156)\'/%3E%3Cpath d=\'M0 0 C1.57446879 0.03538653 3.14891622 0.07173456 4.7233429 0.10894775 C6.38922963 0.11176994 8.05512879 0.11018232 9.7210083 0.10452271 C14.23606528 0.10165583 18.74846025 0.16039819 23.26289892 0.23026228 C27.98330998 0.2928208 32.70378366 0.29865294 37.42454529 0.31051636 C46.36038207 0.34158515 55.29499389 0.42362715 64.23029149 0.52401125 C74.40418698 0.63582663 84.57814131 0.69077766 94.75249839 0.7409656 C115.67852193 0.84546264 136.60344311 1.02132815 157.52851868 1.24420166 C157.95971575 1.99168356 158.39091282 2.73916546 158.83517647 3.50929832 C160.45471906 6.31674699 162.07429028 9.12417914 163.69388008 11.93160057 C164.39114932 13.14027074 165.08840757 14.34894725 165.78565407 15.55763054 C169.50738164 22.00926293 173.22971297 28.4605386 176.95820618 34.90826416 C180.48950915 41.01572558 184.0123762 47.1279998 187.52851868 53.24420166 C188.03270325 54.12044189 188.53688782 54.99668213 189.05635071 55.8994751 C190.3647209 58.17816336 191.66688022 60.46024099 192.96601868 62.74420166 C193.33775208 63.39082764 193.70948547 64.03745361 194.09248352 64.70367432 C196.52851868 69.01247877 196.52851868 69.01247877 196.52851868 71.24420166 C140.09851868 71.57420166 83.66851868 71.90420166 25.52851868 72.24420166 C21.23851868 79.83420166 16.94851868 87.42420166 12.52851868 95.24420166 C11.86851868 96.23420166 11.20851868 97.22420166 10.52851868 98.24420166 C11.56919558 98.24105926 12.60987247 98.23791685 13.68208504 98.23467922 C38.99527189 98.16030118 64.30810299 98.13755064 89.62138557 98.16904354 C101.86272813 98.18307605 114.10363668 98.18028682 126.34492493 98.13800049 C137.01355154 98.10118933 147.68164892 98.09583447 158.35029781 98.12837225 C164.00034463 98.14450232 169.64939864 98.14479961 175.299366 98.10743523 C180.61696066 98.07276568 185.93283596 98.08014023 191.25037956 98.11983109 C193.20228472 98.12697733 195.15431594 98.11873206 197.10607719 98.09397697 C211.87769011 97.91936809 211.87769011 97.91936809 215.97661209 101.20886135 C217.54999727 103.52290617 218.5627607 105.62835565 219.52851868 108.24420166 C220.51755188 109.83881226 220.51755188 109.83881226 221.52656555 111.46563721 C223.38190367 114.60902434 225.20951307 117.76715589 227.02851868 120.93170166 C227.68594055 122.03320557 228.34336243 123.13470947 229.02070618 124.26959229 C229.93722961 125.87157471 229.93722961 125.87157471 230.87226868 127.50592041 C231.43107727 128.46458008 231.98988586 129.42323975 232.56562805 130.41094971 C233.83919126 134.1583384 233.15051157 135.68064961 231.52851868 139.24420166 C230.45549332 141.31551932 229.32791339 143.35916952 228.15742493 145.37701416 C227.50064758 146.51267822 226.84387024 147.64834229 226.16719055 148.81842041 C225.82615295 149.40156006 225.48511536 149.98469971 225.13374329 150.58551025 C224.09176378 152.36792709 223.05853655 154.15519398 222.02656555 155.94342041 C218.31009444 162.34259398 218.31009444 162.34259398 216.52851868 165.24420166 C216.16513995 165.95012577 215.80176123 166.65604988 215.42737103 167.38336563 C212.50865275 170.24364917 209.32748203 169.80159595 205.46109009 169.76318359 C204.62956568 169.77068485 203.79804128 169.7781861 202.94131917 169.78591466 C200.14502097 169.80627254 197.34952737 169.79807344 194.55317688 169.7901001 C192.5527516 169.79883072 190.55233332 169.8093147 188.55192566 169.82142639 C183.11213896 169.84936959 177.67257917 169.85268924 172.2327311 169.8517065 C166.55117939 169.85482847 160.86973097 169.88043168 155.18823242 169.90368652 C144.42542127 169.94430508 133.66267078 169.96460099 122.89979476 169.97766042 C110.64839222 169.99351065 98.39709323 170.03191791 86.14575064 170.0722537 C60.94004137 170.15473278 35.73433487 170.20877483 10.52851868 170.24420166 C10.94738342 170.96075928 11.36624817 171.67731689 11.79780579 172.41558838 C13.68785558 175.64974941 15.57694895 178.88446808 17.46601868 182.11920166 C18.12537415 183.24713135 18.78472961 184.37506104 19.46406555 185.53717041 C20.09248352 186.6135376 20.72090149 187.68990479 21.36836243 188.79888916 C21.94964905 189.79388428 22.53093567 190.78887939 23.12983704 191.81402588 C23.96751337 193.2694684 24.7775174 194.74219911 25.52851868 196.24420166 C110.17351868 196.73920166 110.17351868 196.73920166 196.52851868 197.24420166 C195.06047639 201.64832853 193.85135985 204.72303144 191.57929993 208.60357666 C190.98568665 209.62435303 190.39207336 210.64512939 189.7804718 211.69683838 C188.8204425 213.3290332 188.8204425 213.3290332 187.84101868 214.99420166 C186.82983509 216.72931196 185.81866048 218.46442758 184.80802917 220.19985962 C183.75634744 222.00432342 182.70235231 223.80742185 181.64814758 225.6104126 C178.24831138 231.43128811 174.89156553 237.27702118 171.52851868 243.11920166 C168.01496765 249.21712363 168.01496765 249.21712363 166.30715847 252.06988907 C164.48320069 255.17864615 164.48320069 255.17864615 163.22710514 258.38851547 C161.65190971 261.8770177 160.15756142 264.44821005 157.52851868 267.24420166 C152.21731943 269.10299354 146.9961571 269.01156602 141.44233704 268.98736572 C139.79890505 269.02330523 138.15557406 269.06414526 136.51237488 269.10949707 C132.05896824 269.21528671 127.60832808 269.24361975 123.15378642 269.25128651 C120.36582009 269.25983445 117.57855083 269.28548474 114.79075813 269.31725311 C105.04835222 269.42822262 95.30791253 269.47728536 85.56489563 269.46783447 C76.50862575 269.46063501 67.46095833 269.58700045 58.40686506 269.77675843 C50.61338248 269.93422126 42.82269372 269.99801966 35.02763468 269.99036956 C30.37964315 269.9873224 25.73928776 270.02068183 21.0928936 270.14850616 C-7.03377558 270.86980625 -7.03377558 270.86980625 -14.37728691 264.87015915 C-19.10161657 259.1820163 -21.96974879 252.94997387 -24.43922424 246.02556229 C-25.77952745 242.41418812 -27.55288761 239.38676069 -29.59257507 236.12701416 C-30.6986544 234.20809514 -31.8041386 232.28883294 -32.90898132 230.36920166 C-34.16807934 228.18429628 -35.42719443 225.99940074 -36.68632507 223.81451416 C-37.31135925 222.7294458 -37.93639343 221.64437744 -38.58036804 220.52642822 C-41.70828281 215.09760224 -44.8400658 209.67100885 -47.97148132 204.24420166 C-49.22150011 202.07754583 -50.47150011 199.91087916 -51.72148132 197.74420166 C-52.34023132 196.67170166 -52.95898132 195.59920166 -53.59648132 194.49420166 C-59.22148132 184.74420166 -59.22148132 184.74420166 -61.09965515 181.48858643 C-62.33894399 179.3405612 -63.57836273 177.19261091 -64.81791687 175.04473877 C-67.753507 169.95764617 -70.68773804 164.86978319 -73.61738586 159.77926636 C-75.00476227 157.36876418 -76.39287756 154.9586879 -77.78105164 152.54864502 C-78.76321947 150.84276198 -79.74431517 149.1362618 -80.72538757 147.42974854 C-81.31835632 146.40043213 -81.91132507 145.37111572 -82.52226257 144.31060791 C-83.04473572 143.40254395 -83.56720886 142.49447998 -84.10551453 141.55889893 C-85.17126098 139.75293966 -86.30828885 137.98899037 -87.47148132 136.24420166 C-87.22295781 131.41941759 -84.6284725 127.52602379 -82.28398132 123.43170166 C-81.84400818 122.65181885 -81.40403503 121.87193604 -80.95072937 121.06842041 C-76.10882972 112.52438242 -71.13775362 104.05408113 -66.17460632 95.58013916 C-62.43513543 89.19138174 -58.73023098 82.7830409 -55.03398132 76.36920166 C-54.41176697 75.28961182 -53.78955261 74.21002197 -53.14848328 73.09771729 C-51.88636616 70.90737646 -50.62440347 68.71694664 -49.3625946 66.52642822 C-45.61709697 60.02572203 -41.86650867 53.52795134 -38.11650085 47.02984619 C-35.21853243 42.00766464 -32.32153845 36.984931 -29.4287262 31.95977783 C-28.41200934 30.19374644 -27.39492474 28.42792735 -26.37773132 26.66217041 C-25.10747259 24.45686011 -23.83789114 22.2511595 -22.56913757 20.04498291 C-21.98905945 19.0382251 -21.40898132 18.03146729 -20.81132507 16.99420166 C-20.05903625 15.68709229 -20.05903625 15.68709229 -19.29154968 14.35357666 C-18.69092712 13.32748291 -18.09030457 12.30138916 -17.47148132 11.24420166 C-17.16758704 10.43529291 -16.86369276 9.62638416 -16.55058956 8.79296303 C-12.95528867 0.6560312 -8.38997823 -0.0160627 0 0 Z \' fill=\'%231B63F2\' transform=\'translate(219.4714813232422,120.75579833984375)\'/%3E%3C/svg%3E',
      loginData: {},
      async connect() {
        const chainId = await this.getChainId();
        const accounts = await this.getAccounts();

        return { accounts, chainId }
      },
      async disconnect() {
        isConnected = false;
        provider = null;
        ethermailProvider = null;

        removeEthermailLoginElement();
        removeEthermailSDKScript();
      },
      async getAccounts() {
        if (!provider) throw new Error('Not connected');
        const signer = await provider.getSigner();

        return [signer.address as `0x${string}`];
      },
      async getChainId() {
        if (!provider) await this.getProvider();

        const network = await provider?.getNetwork();
        if (!network) throw new Error('No network found');

        const chainId = network.chainId.toString();
        return +chainId;
      },
      async getProvider() {
        if (!ethermailProvider) {
          createEthermailLoginElement(
            process.env.NEXT_PUBLIC_WIDGET_ID ?? '',
            parameters.loginType ?? 'wallet',
            parameters.permissions ?? 'write',
            parameters.connectButtonLabel ?? 'Connect Wallet'
          );

          await runEthermailSDKScript();

          await new Promise((resolve) => {
            const check = () => {
              if (customElements.get('ethermail-login')) resolve(true);
              else setTimeout(check, 50);
            };
            check();
          });

          const ethermailLogin = document.querySelector('ethermail-login');
          if (!ethermailLogin) {
            throw new Error('Ethermail login element not found');
          }

          const shadowRoot = ethermailLogin.shadowRoot;
          if (!shadowRoot) {
            throw new Error('Shadow root not found');
          }

          const loginButton = shadowRoot.querySelector('.ethermail-login-button');
          if (!loginButton) {
            throw new Error('Ethermail login button not found');
          }
          (loginButton as HTMLElement).click();

          addEthermailLoginErrorListener();

          return await new Promise<EtherMailProvider>((resolve, reject) => {
            let timeoutId = setTimeout(() => {
              reject(new Error('Ethermail login timed out after 60 seconds'));
            }, 60000); // 60-second timeout

            const handleSignInSuccess = async (event: Event) => {
              const successEvent = event as EtherMailSignInOnSuccessEvent;
              console.log('EtherMailSignInOnSuccess event heard!', successEvent);

              const jwtUtils = new JwtUtils();
              const sessionToken = successEvent.detail.token;

              const tokenVerificationResponse = await jwtUtils.verifyToken(sessionToken);
              if (tokenVerificationResponse.message !== 'Token is valid') {
                reject(new Error('Invalid Token!'));
                return;
              }

              this.loginData = jwtUtils.decodeToken(sessionToken) as EthermailLoginData;
              console.log('Decoded login data:', this.loginData);

              ethermailProvider = new EtherMailProvider({
                websocketServer: `wss://${process.env.NEXT_PUBLIC_ETHERMAIL_API_DOMAIN}/events`,
                appUrl: `https://${process.env.NEXT_PUBLIC_ETHERMAIL_DOMAIN}`,
              });
              ethermailProvider.on('chainChanged', (chainId: string) => {
                toast(`Listen event Chain changed to ${chainId}`);
              })

              ethermailProvider.on('disconnect', () => {
                toast('Disconnect event heard!');
              });

              ethermailProvider.on('message', () => {
                toast('Message event heard!');
              });

              provider = new BrowserProvider(ethermailProvider);
              isConnected = true;
              clearTimeout(timeoutId);

              resolve(ethermailProvider);
            };

            window.addEventListener('EtherMailSignInOnSuccess', handleSignInSuccess, { once: true });
          });
        }

        return ethermailProvider;
      },
      async switchChain({ addEthereumChainParameter, chainId }) {
        if (!provider) await this.getProvider()
        if (!ethermailProvider) throw new Error('Connect wallet before');

        const chain = config.chains.find((x: Chain) => x.id === chainId)
        await ethermailProvider.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: chainId }],
        });

        provider = getBrowserProvider(ethermailProvider);

        config.emitter.emit('change', { chainId })

        return chain;
      },
      async isAuthorized() {
        return isConnected;
      },
      onAccountsChanged(accounts: `0x${string}`[]) {},
      onChainChanged(chainId: string) {
        toast(`Chain changed to ${chainId}`);
        // Handle chain changes (e.g., update app state)
      },
      onDisconnect() {},
    };
  });
}

const getBrowserProvider = (ethermailProvider: EtherMailProvider) => {
  return new BrowserProvider(ethermailProvider);
}

const createEthermailLoginElement = (widgetId: string, loginType: string, ssoPermission: string, label: string) => {
  if (!document.getElementById('ethermail-login')) {
    const ethermailLogin = document.createElement('ethermail-login');

    // Set attributes (widget, type, permissions, label)
    ethermailLogin.setAttribute('widget', widgetId);
    ethermailLogin.setAttribute('type', loginType);
    ethermailLogin.setAttribute('permissions', ssoPermission);
    ethermailLogin.setAttribute('label', label);

    ethermailLogin.style.position = 'absolute'; // Option 2: Move off-screen
    ethermailLogin.style.left = '-9999px';

    // Append to the document body
    document.body.appendChild(ethermailLogin);
  }
}

const runEthermailSDKScript = async () => {
  (function({ ...args }) {
    if (!document.getElementById('ethermail-sdk-script')) {
      var p = document.createElement('script');
      p.id = 'ethermail-sdk-script';
      p.src = process.env.NEXT_PUBLIC_WIDGET_URL ?? 'https://cdn-email.ethermail.io/sdk/v2/ethermail.js';
      document.body.appendChild(p);
      p.setAttribute('a', args.afid);
      p.setAttribute('b', args.communityAlias);
      // @ts-ignore
      p.setAttribute('c', args.features);
    }
  })({
    afid: process.env.NEXT_PUBLIC_WIDGET_AFID ?? '65ddf7aa3631bb310429bbb7',
    communityAlias: process.env.NEXT_PUBLIC_WIDGET_COMMUNITY_NAME ?? 'ethermail',
    features: ['login'],
  });
}

const removeEthermailLoginElement = () => {
  const ethermailLogin = document.querySelector('ethermail-login');
  if (ethermailLogin) {
    ethermailLogin.remove();
  }
};

const removeEthermailSDKScript = () => {
  const sdkScript = document.getElementById('ethermail-sdk-script');
  if (sdkScript) {
    sdkScript.remove();
  }
};

const addEthermailLoginErrorListener = () => {
  window.addEventListener('EtherMailTokenError', (event: Event) => {
    console.log(event);
    const errorEvent = event as EtherMailTokenErrorEvent;
    if (errorEvent.detail.type === 'expired') {
      toast.error('Expired Session!');
    } else if (errorEvent.detail.type === 'permissions') {
      toast.error('Permissions Error!');
    }
  });
}